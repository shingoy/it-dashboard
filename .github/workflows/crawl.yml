name: Government IT Meeting Crawler

on:
  schedule:
    - cron: '0 21 * * *'
  workflow_dispatch:

jobs:
  crawl-and-build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install Python dependencies
        run: |
          pip install -r requirements.txt
      
      - name: Run crawler
        id: crawl
        run: |
          python scripts/crawl.py
          echo "status=success" >> $GITHUB_OUTPUT
        continue-on-error: true
      
      - name: Run text extraction
        id: extract
        if: steps.crawl.outcome == 'success'
        run: |
          python scripts/extract.py
          echo "status=success" >> $GITHUB_OUTPUT
        continue-on-error: true
      
      - name: Build search index
        id: build_index
        if: steps.extract.outcome == 'success'
        run: |
          python scripts/build_index.py
          echo "status=success" >> $GITHUB_OUTPUT
        continue-on-error: true
      
      - name: Check for changes
        id: check_changes
        run: |
          if git diff --quiet public/; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Commit and push changes
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add public/
          git add data/docs_cache.json
          git commit -m "Update search index - $(date +'%Y-%m-%d %H:%M:%S')"
          git push
      
      - name: Upload failed URLs artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: failed-urls-${{ github.run_number }}
          path: data/failed_urls.json
          if-no-files-found: ignore
          retention-days: 30
      
      - name: Upload extraction summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: extraction-summary-${{ github.run_number }}
          path: data/extraction_summary.json
          if-no-files-found: ignore
          retention-days: 30
      
      - name: Create summary
        if: always()
        run: |
          echo "## Crawl Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Crawl**: ${{ steps.crawl.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Extract**: ${{ steps.extract.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Index**: ${{ steps.build_index.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Has Changes**: ${{ steps.check_changes.outputs.has_changes }}" >> $GITHUB_STEP_SUMMARY
```

5. ä¸‹ã® **Commit changes** ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
6. ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç¢ºèªã—ã¦ **Commit changes** ã‚’ã‚¯ãƒªãƒƒã‚¯

### æ–¹æ³•2: GitHub.devã‚¨ãƒ‡ã‚£ã‚¿ã‚’ä½¿ã†

1. GitHubãƒªãƒã‚¸ãƒˆãƒªãƒšãƒ¼ã‚¸ã§ **`.`** (ãƒ”ãƒªã‚ªãƒ‰) ã‚­ãƒ¼ã‚’æŠ¼ã™
2. VS Codeé¢¨ã®ã‚¨ãƒ‡ã‚£ã‚¿ãŒé–‹ã
3. å·¦å´ã® **Explorer** ã§å³ã‚¯ãƒªãƒƒã‚¯ â†’ **New Folder** â†’ `.github`
4. `.github` ã‚’å³ã‚¯ãƒªãƒƒã‚¯ â†’ **New Folder** â†’ `workflows`
5. `workflows` ã‚’å³ã‚¯ãƒªãƒƒã‚¯ â†’ **New File** â†’ `crawl.yml`
6. ä¸Šè¨˜ã®å†…å®¹ã‚’ãƒšãƒ¼ã‚¹ãƒˆ
7. å·¦å´ã® **Source Control** ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
8. å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆï¼†ãƒ—ãƒƒã‚·ãƒ¥

## ğŸ“ ä»–ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚‚åŒæ§˜ã«ä½œæˆ

åŒã˜æ–¹æ³•ã§ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚‚ä½œæˆã§ãã¾ã™ï¼š

### `scripts/crawl.py`
1. **Add file** â†’ **Create new file**
2. ãƒ•ã‚¡ã‚¤ãƒ«å: `scripts/crawl.py`
3. Artifact `crawl-script` ã®å†…å®¹ã‚’ã‚³ãƒ”ãƒ¼ï¼†ãƒšãƒ¼ã‚¹ãƒˆ
4. Commit

### `scripts/extract.py`
1. ãƒ•ã‚¡ã‚¤ãƒ«å: `scripts/extract.py`
2. Artifact `extract-script` ã®å†…å®¹ã‚’ã‚³ãƒ”ãƒ¼ï¼†ãƒšãƒ¼ã‚¹ãƒˆ
3. Commit

### `scripts/build_index.py`
1. ãƒ•ã‚¡ã‚¤ãƒ«å: `scripts/build_index.py`
2. Artifact `build-index-script` ã®å†…å®¹ã‚’ã‚³ãƒ”ãƒ¼ï¼†ãƒšãƒ¼ã‚¹ãƒˆ
3. Commit

### `requirements.txt`
1. ãƒ•ã‚¡ã‚¤ãƒ«å: `requirements.txt`
2. å†…å®¹ï¼š
```
requests==2.31.0
beautifulsoup4==4.12.3
pymupdf==1.24.0
lxml==5.1.0
